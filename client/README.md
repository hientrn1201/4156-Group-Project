# Knowledge Management Service Client

A command-line client for interacting with the AI Knowledge Management Service API.

## What This Client Does

This client provides a command-line interface to interact with the Knowledge Management Service. It allows you to:

- **Upload documents** for AI-powered processing (text extraction, chunking, embedding, summarization)
- **List and retrieve documents** from the service
- **Search documents** using semantic search
- **Get document summaries** generated by AI
- **View processing statistics** for all documents
- **Delete documents** from the service

The client is designed to support multiple simultaneous instances, each identified by a unique client ID. This allows you to run multiple clients at the same time, and the service can distinguish between them.

## Prerequisites

- Python 3.7 or higher
- `requests` library

## Installation

### Option 1: Using Virtual Environment (Recommended)

1. Navigate to the client directory:
   ```bash
   cd client
   ```

2. Create a virtual environment:
   ```bash
   python3 -m venv venv
   ```

3. Activate the virtual environment:
   ```bash
   # On macOS/Linux:
   source venv/bin/activate
   
   # On Windows:
   venv\Scripts\activate
   ```

4. Install dependencies:
   ```bash
   pip install requests
   ```

### Option 2: Global Installation

If you prefer to install globally (may require `--break-system-packages` on some systems):
```bash
pip install requests
# or
pip install --user requests
```

## Usage

**Important:** Make sure your Knowledge Management Service is running before using the client!

### Basic Commands

#### Upload a Document
```bash
python client.py upload <file_path>
```

Example:
```bash
python client.py upload document.pdf
python client.py upload /path/to/document.docx
```

#### List All Documents
```bash
python client.py list
```

Filter by filename:
```bash
python client.py list --filename document.pdf
```

#### Get a Specific Document
```bash
python client.py get <document_id>
```

Example:
```bash
python client.py get 1
```

#### Get Document Summary
```bash
python client.py summary <document_id>
```

Example:
```bash
python client.py summary 1
```

#### Get All Documents with Summaries
```bash
python client.py summaries
```

#### Get Document Relationships
```bash
python client.py relationships <document_id>
```

Example:
```bash
python client.py relationships 1
```

#### Get Processing Statistics
```bash
python client.py stats
```

#### Search Documents
```bash
python client.py search "<query>"
```

Example:
```bash
python client.py search "machine learning"
python client.py search "artificial intelligence"
```

#### Delete a Document
```bash
python client.py delete <document_id>
```

Example:
```bash
python client.py delete 1
```

#### Get Welcome Message
```bash
python client.py welcome
```

## Configuration

The client can be configured in two ways:

### 1. Command-line arguments

Use `--url` and `--client-id` flags:
```bash
python client.py --url http://localhost:8080 --client-id my-client-001 upload doc.pdf
```

### 2. Environment variables

Set environment variables:
```bash
export SERVICE_URL=http://localhost:8080
export CLIENT_ID=my-client-001
python client.py upload doc.pdf
```

### Defaults

- **Service URL**: `http://localhost:8080` (or value from `SERVICE_URL` env var)
- **Client ID**: Auto-generated timestamp-based ID (or value from `CLIENT_ID` env var)

## Connecting to Your Service

### Local Service

If your service is running locally on the default port:
```bash
python client.py upload document.pdf
```

### Custom URL

If your service is running on a different URL:
```bash
python client.py --url http://localhost:9000 upload document.pdf
```

### Cloud Deployment

If your service is deployed to the cloud:
```bash
python client.py --url https://your-service.appspot.com upload document.pdf
```

## Multiple Client Instances

The client supports running multiple instances simultaneously. Each instance is identified by a unique client ID, which is sent in the `X-Client-ID` header with every request.

### Running Multiple Instances

**Option 1: Different Client IDs via Command Line**
```bash
# Terminal 1
python client.py --client-id client-001 upload doc1.pdf

# Terminal 2
python client.py --client-id client-002 upload doc2.pdf

# Terminal 3
python client.py --client-id client-003 search "AI"
```

**Option 2: Different Client IDs via Environment Variables**
```bash
# Terminal 1
export CLIENT_ID=client-001
python client.py upload doc1.pdf

# Terminal 2
export CLIENT_ID=client-002
python client.py upload doc2.pdf
```

**Option 3: Auto-generated IDs**
If you don't specify a client ID, each instance will get a unique auto-generated ID based on the current timestamp.

### How the Service Distinguishes Clients

The service uses the `X-Client-ID` HTTP header to identify each client. When a client makes a request:

1. The client sends its unique ID in the `X-Client-ID` header
2. The service extracts this ID (or uses the client's IP address as a fallback)
3. The service logs all API calls with the client ID for tracking
4. Multiple clients can make requests simultaneously without conflicts

You can verify this by checking the service logs, which will show entries like:
```
Received file upload: document.pdf from client: client-001 (requestId: ...)
```

## Testing the Client

### Quick Test

1. Make sure your service is running:
   ```bash
   # In your project root
   docker-compose up -d  # Start PostgreSQL and Ollama
   mvn spring-boot:run   # Start the service
   ```

2. Test the welcome endpoint:
   ```bash
   python client.py welcome
   ```

3. Test listing documents:
   ```bash
   python client.py list
   ```

4. Test getting statistics:
   ```bash
   python client.py stats
   ```

### Full Workflow Test

```bash
# 1. Upload a document
python client.py --client-id my-client upload test-document.txt

# 2. Wait for processing, then list documents
python client.py --client-id my-client list

# 3. Get the document details (use the ID from step 2)
python client.py --client-id my-client get 1

# 4. Get the AI-generated summary
python client.py --client-id my-client summary 1

# 5. Search for related content
python client.py --client-id my-client search "test"

# 6. Check processing statistics
python client.py --client-id my-client stats
```

### Using the Test Script

A simple test script is provided:
```bash
# Make sure you're in the project root
./client/test_client.sh
```

## Examples

### Complete Workflow

```bash
# 1. Upload a document
python client.py --client-id my-client upload research_paper.pdf

# 2. Wait for processing, then list documents
python client.py --client-id my-client list

# 3. Get the document details
python client.py --client-id my-client get 1

# 4. Get the AI-generated summary
python client.py --client-id my-client summary 1

# 5. Search for related content
python client.py --client-id my-client search "neural networks"

# 6. Check processing statistics
python client.py --client-id my-client stats
```

### Concurrent Operations

```bash
# Terminal 1: Upload document
python client.py --client-id client-1 upload doc1.pdf

# Terminal 2: Upload another document (simultaneously)
python client.py --client-id client-2 upload doc2.pdf

# Terminal 3: Search while uploads are happening
python client.py --client-id client-3 search "AI"
```

## Error Handling

The client provides clear error messages for common issues:

- **Connection errors**: Service is not running or URL is incorrect
- **File not found**: Document path is invalid
- **HTTP errors**: Service returned an error (e.g., document not found, validation error)
- **Timeout errors**: Request took too long (especially for large file uploads)

## Output Format

The client provides human-readable output by default. For JSON output, you can pipe to `jq` or modify the client code to always output JSON.

## Troubleshooting

### "Could not connect to service"
- Verify the service is running: `curl http://localhost:8080/api`
- Check the URL is correct: `python client.py --url <correct_url> welcome`

### "File not found"
- Use absolute paths: `python client.py upload /full/path/to/file.pdf`
- Or navigate to the directory containing the file first

### "Request timed out"
- Large files may take time to process
- The client has a 5-minute timeout for uploads
- Check service logs to see if processing is still ongoing

### "ModuleNotFoundError: No module named 'requests'"
- Make sure you've installed requests: `pip install requests`
- If using a virtual environment, make sure it's activated: `source venv/bin/activate`

## For Third-Party Developers

If you want to develop your own client for this service, here's what you need to know:

### API Base URL
- Local: `http://localhost:8080/api/v1`
- Cloud: `https://your-deployment-url/api/v1`

### Required Headers
- `X-Client-ID`: A unique identifier for your client instance (string)

### Key Endpoints

1. **POST** `/api/v1/documents` - Upload document (multipart/form-data, field name: `file`)
2. **GET** `/api/v1/documents` - List all documents (optional query param: `filename`)
3. **GET** `/api/v1/documents/{id}` - Get document by ID
4. **GET** `/api/v1/documents/{id}/summary` - Get document summary
5. **GET** `/api/v1/documents/summaries` - Get all documents with summaries
6. **GET** `/api/v1/documents/stats` - Get processing statistics
7. **GET** `/api/v1/search/{text}` - Semantic search (URL-encode the search text)
8. **DELETE** `/api/v1/documents/{id}` - Delete document
9. **GET** `/api` - Welcome message

### Response Format
All endpoints return JSON (except the welcome endpoint which returns plain text).

### Error Responses
- `400 Bad Request`: Invalid input
- `404 Not Found`: Resource not found
- `500 Internal Server Error`: Server error

### Client Identification
Always include the `X-Client-ID` header with a unique identifier. This allows the service to:
- Log which client made each request
- Support multiple simultaneous clients
- Track client-specific operations

### Example (Python)
```python
import requests

url = "http://localhost:8080/api/v1/documents"
headers = {"X-Client-ID": "my-unique-client-id"}

# Upload
with open("document.pdf", "rb") as f:
    files = {"file": f}
    response = requests.post(url, files=files, headers=headers)
    print(response.json())

# Search
search_url = "http://localhost:8080/api/v1/search/machine%20learning"
response = requests.get(search_url, headers=headers)
print(response.json())
```

### Example (curl)
```bash
# Upload
curl -X POST http://localhost:8080/api/v1/documents \
  -H "X-Client-ID: my-client-001" \
  -F "file=@document.pdf"

# Search
curl "http://localhost:8080/api/v1/search/machine%20learning" \
  -H "X-Client-ID: my-client-001"
```

See the main service README for complete API documentation.
